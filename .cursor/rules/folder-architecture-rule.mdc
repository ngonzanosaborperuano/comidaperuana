---
description: Define la estructura de carpetas y organizaci√≥n de archivos del proyecto siguiendo Clean Architecture con separaci√≥n por features.
globs:
alwaysApply: true
---

# Rule: folder_architecture

## Objective

**OBLIGATORIO**: Seguir estrictamente la estructura de carpetas definida en `docs/flujo_de_arquitectura.md`. Esta arquitectura garantiza separaci√≥n de responsabilidades, mantenibilidad y escalabilidad del proyecto.

---

## Estructura General

### üìÅ Niveles Principales

```
lib/
‚îú‚îÄ‚îÄ core/          # C√≥digo compartido y base del proyecto
‚îú‚îÄ‚îÄ common/        # Widgets y componentes compartidos
‚îî‚îÄ‚îÄ features/      # Features organizadas por dominio
```

---

## üì¶ Core (`lib/core/`)

**Prop√≥sito**: C√≥digo compartido, servicios base, utilidades y configuraciones globales.

### ‚úÖ OBLIGATORIO: Organizaci√≥n de Core

#### `core/theme/`
- **Prop√≥sito**: Sistema de temas y estilos globales
- **Archivos requeridos**:
  - `app_colors.dart` - Paleta de colores centralizada
  - `app_typography.dart` - Tipograf√≠a y estilos de texto
  - `material_theme.dart` - ThemeData para Material Design
  - `cupertino_theme.dart` - CupertinoThemeData para iOS

```dart
// ‚úÖ CORRECTO: Usar colores desde app_colors.dart
Container(
  color: AppColors.primary,
  child: Text(
    'Hello',
    style: AppTypography.headline1,
  ),
)
```

#### `core/ui/`
- **Prop√≥sito**: Componentes UI adaptativos y espec√≠ficos de plataforma
- **Estructura**:
  - `adaptive/` - Widgets que se adaptan autom√°ticamente (Material/Cupertino)
  - `material/` - Widgets espec√≠ficos de Material Design
  - `cupertino/` - Widgets espec√≠ficos de iOS

**Reglas**:
- **OBLIGATORIO**: Usar widgets `adaptive/` cuando sea posible para soporte multiplataforma
- **OBLIGATORIO**: Usar widgets `material/` o `cupertino/` solo cuando se requiera estilo espec√≠fico

```dart
// ‚úÖ CORRECTO: Widget adaptativo
AdaptiveScaffold(
  appBar: AdaptiveAppBar(title: Text('Home')),
  body: AdaptiveButton(
    onPressed: () {},
    child: Text('Click me'),
  ),
)

// ‚úÖ CORRECTO: Widget espec√≠fico cuando se requiere
MaterialButton(
  onPressed: () {},
  child: Text('Material only'),
)
```

#### `core/utils/`
- **Prop√≥sito**: Utilidades y helpers reutilizables
- **Archivos**:
  - `platform_utils.dart` - Detecci√≥n de plataforma (`isIOS`, `isAndroid`, etc.)
  - `validators.dart` - Validaciones de formularios
  - `logger.dart` - Servicio de logging centralizado

**Reglas**:
- **OBLIGATORIO**: Usar `logger.dart` en lugar de `print()`
- **OBLIGATORIO**: Centralizar validaciones en `validators.dart`

#### `core/extensions/`
- **Prop√≥sito**: Extensiones de Dart/Flutter para mejorar API
- **Archivos**:
  - `context_extensions.dart` - Extensiones de `BuildContext`
  - `string_extensions.dart` - Extensiones de `String`
  - `iterable_extensions.dart` - Extensiones de `Iterable`

**Reglas**:
- **OBLIGATORIO**: Agrupar extensiones por tipo
- **OBLIGATORIO**: Documentar extensiones p√∫blicas

#### `core/generics/`
- **Prop√≥sito**: Tipos gen√©ricos y estructuras de datos reutilizables
- **Archivos**:
  - `result.dart` - Tipo `Result<T>` o `Either<Failure, T>` gen√©rico
  - `paginated_list.dart` - Estructura para listas paginadas

**Reglas**:
- **OBLIGATORIO**: Usar `Result` o `Either` de fpdart para manejo de errores
- **OBLIGATORIO**: Implementar `Equatable` en tipos gen√©ricos cuando sea necesario

#### `core/services/`
- **Prop√≥sito**: Servicios globales y singletons
- **Archivos**:
  - `firebase_service.dart` - Inicializaci√≥n y configuraci√≥n de Firebase
  - `local_storage_service.dart` - Abstracci√≥n de almacenamiento local (SharedPreferences/Hive)
  - `network_info.dart` - Detecci√≥n de conectividad
  - `api_client.dart` - Cliente HTTP (Dio, http, etc.)

**Reglas**:
- **OBLIGATORIO**: Registrar servicios como Lazy Singletons en `injection.dart`
- **OBLIGATORIO**: Implementar interfaces para servicios (para testing)
- **OBLIGATORIO**: Usar `Either<Failure, T>` para operaciones que pueden fallar

### üîå Inyecci√≥n de dependencias (`lib/core/injection.dart`)
- **Prop√≥sito**: Punto √∫nico para declarar y registrar dependencias siguiendo el flujo Data ‚Üí Domain ‚Üí Presentation.
- **Reglas**:
  - **OBLIGATORIO**: Registrar servicios y clients compartidos como `registerLazySingleton`.
  - **OBLIGATORIO**: Registrar `UseCase` y repositorios de dominio como `registerLazySingleton`.
  - **OBLIGATORIO**: Registrar BLoC/Cubit en `registerFactory` para obtener instancias limpias por pantalla.
  - **OBLIGATORIO**: Mantener el orden de registro: data (sources/clients) ‚Üí repositorios (impl) ‚Üí casos de uso ‚Üí presentadores (bloc/cubit).
  - **PROHIBIDO**: Registrar dependencias directamente en widgets/p√°ginas; todo debe pasar por `injection.dart`.
- **Ejemplo**:
```dart
Future<void> configureDependencies() async {
  // Data
  getIt.registerLazySingleton<ApiClient>(() => ApiClientImpl());
  getIt.registerLazySingleton<AuthApiSource>(
    () => AuthApiSource(apiClient: getIt()),
  );

  // Domain
  getIt.registerLazySingleton<IAuthRepository>(
    () => AuthRepositoryImpl(remoteSource: getIt()),
  );
  getIt.registerLazySingleton<LoginUseCase>(
    () => LoginUseCase(repository: getIt()),
  );

  // Presentation
  getIt.registerFactory<AuthBloc>(
    () => AuthBloc(loginUseCase: getIt()),
  );
}
```

#### `core/errors/`
- **Prop√≥sito**: Manejo centralizado de errores y excepciones
- **Archivos**:
  - `exceptions.dart` - Excepciones espec√≠ficas (ServerException, CacheException, etc.)
  - `failures.dart` - Failures para programaci√≥n funcional (ServerFailure, AuthFailure, etc.)
  - `error_mapper.dart` - Mapeo de Exception ‚Üí Failure

**Reglas**:
- **OBLIGATORIO**: Usar `Failure` en lugar de `Exception` en la capa de dominio
- **OBLIGATORIO**: Mapear `Exception` ‚Üí `Failure` en la capa de datos
- **OBLIGATORIO**: Implementar `Equatable` en todas las clases `Failure`

#### `core/config/`
- **Prop√≥sito**: Configuraciones y variables de entorno
- **Archivos**:
  - `flavor_config.dart` - Configuraci√≥n de flavors (dev, staging, prod)
  - `env.dart` - Variables de entorno y claves de API

**Reglas**:
- **OBLIGATORIO**: Usar `env.dart` para acceso a variables de entorno
- **OBLIGATORIO**: No hardcodear URLs, claves o configuraciones

---

## üß© Common (`lib/common/`)

**Prop√≥sito**: Widgets y componentes compartidos entre m√∫ltiples features.

### ‚úÖ OBLIGATORIO: Organizaci√≥n de Common

#### `common/widgets/`
- **Prop√≥sito**: Widgets reutilizables gen√©ricos
- **Archivos t√≠picos**:
  - `loading_indicator.dart` - Indicador de carga
  - `empty_state.dart` - Estado vac√≠o
  - `error_view.dart` - Vista de error

**Reglas**:
- **OBLIGATORIO**: Widgets deben ser gen√©ricos y reutilizables
- **OBLIGATORIO**: No deben contener l√≥gica de negocio espec√≠fica
- **OBLIGATORIO**: Usar theme system para estilos

```dart
// ‚úÖ CORRECTO: Widget gen√©rico reutilizable
class LoadingIndicator extends StatelessWidget {
  final String? message;
  
  const LoadingIndicator({super.key, this.message});
  
  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          CircularProgressIndicator(
            color: Theme.of(context).colorScheme.primary,
          ),
          if (message != null) ...[
            SizedBox(height: 16),
            Text(
              message!,
              style: Theme.of(context).textTheme.bodyMedium,
            ),
          ],
        ],
      ),
    );
  }
}
```

---

## üéØ Features (`lib/features/`)

**Prop√≥sito**: Features organizadas por dominio de negocio, cada una auto-contenida.

### ‚úÖ OBLIGATORIO: Estructura de Feature

Cada feature **DEBE** seguir esta estructura:

```
features/
‚îî‚îÄ‚îÄ [feature_name]/
    ‚îú‚îÄ‚îÄ data/
    ‚îÇ   ‚îú‚îÄ‚îÄ models/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [entity]_model.dart                   // DTOs
    ‚îÇ   ‚îú‚îÄ‚îÄ sources/                                  // <‚îÄ‚îÄ NUEVO nombre
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [feature]_api_source.dart            // source REST/API
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [feature]_local_source.dart          // source local (cache)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [feature]_firestore_source.dart      // source Firestore
    ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
    ‚îÇ       ‚îî‚îÄ‚îÄ [feature]_repository_impl.dart        // implementa interface
    ‚îú‚îÄ‚îÄ domain/
    ‚îÇ   ‚îú‚îÄ‚îÄ entities/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [entity]_entity.dart                  // objetos de negocio
    ‚îÇ   ‚îú‚îÄ‚îÄ repositories/
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ i_[feature]_repository.dart           // <‚îÄ‚îÄ interfaz con prefijo i_
    ‚îÇ   ‚îî‚îÄ‚îÄ usecases/
    ‚îÇ       ‚îî‚îÄ‚îÄ [action]_usecase.dart                 // casos de uso
    ‚îî‚îÄ‚îÄ presentation/
        ‚îú‚îÄ‚îÄ bloc/
        ‚îÇ   ‚îú‚îÄ‚îÄ [feature]_bloc.dart
        ‚îÇ   ‚îú‚îÄ‚îÄ [feature]_event.dart
        ‚îÇ   ‚îî‚îÄ‚îÄ [feature]_state.dart
        ‚îú‚îÄ‚îÄ pages/
        ‚îÇ   ‚îî‚îÄ‚îÄ [feature]_page.dart
        ‚îî‚îÄ‚îÄ widgets/
            ‚îî‚îÄ‚îÄ [feature]_widget.dart
```

### üìã Reglas por Capa

#### Data Layer (`data/`)

**Prop√≥sito**: Implementaci√≥n de fuentes de datos y modelos.

**Reglas**:
- **OBLIGATORIO**: Usar carpeta `sources/` (NO `datasources/`)
- **OBLIGATORIO**: Sources pueden ser: `api_source`, `local_source`, `firestore_source`
- **OBLIGATORIO**: Models deben extender/convertir a Entities del dominio
- **OBLIGATORIO**: Repository implementation debe implementar la interfaz del dominio
- **OBLIGATORIO**: Usar `Either<Failure, T>` para todas las operaciones

```dart
// ‚úÖ CORRECTO: API Source
class AuthApiSource {
  final ApiClient apiClient;
  
  AuthApiSource({required this.apiClient});
  
  Future<Either<DataSourceFailure, UserModel>> login({
    required String email,
    required String password,
  }) async {
    try {
      final response = await apiClient.post('/auth/login', data: {
        'email': email,
        'password': password,
      });
      
      final user = UserModel.fromJson(response.data);
      return Right(user);
    } on ServerException catch (e) {
      logger.e('Login failed', error: e);
      return Left(DataSourceFailure.server(e.message));
    }
  }
}

// ‚úÖ CORRECTO: Local Source
class AuthLocalSource {
  final LocalStorageService storage;
  
  AuthLocalSource({required this.storage});
  
  Future<Option<UserModel>> getCachedUser(String userId) async {
    // Implementaci√≥n de cache local
  }
  
  Future<Either<DataSourceFailure, Unit>> cacheUser(UserModel user) async {
    // Implementaci√≥n de guardado local
  }
}

// ‚úÖ CORRECTO: Firestore Source
class AuthFirestoreSource {
  final FirebaseFirestore firestore;
  
  AuthFirestoreSource({required this.firestore});
  
  Future<Either<DataSourceFailure, UserModel>> getUserFromFirestore(String userId) async {
    // Implementaci√≥n de Firestore
  }
}
```

#### Domain Layer (`domain/`)

**Prop√≥sito**: L√≥gica de negocio pura, sin dependencias externas.

**Reglas**:
- **OBLIGATORIO**: Entities deben ser objetos inmutables
- **OBLIGATORIO**: Repositories son solo interfaces (abstracciones)
- **OBLIGATORIO**: Use Cases deben ser clases simples con un solo m√©todo `call()`
- **OBLIGATORIO**: No dependencias de Flutter o paquetes externos (excepto fpdart)
- **OBLIGATORIO**: Usar `Either<Failure, T>` para todos los retornos

```dart
// ‚úÖ CORRECTO: Entity inmutable
class UserEntity extends Equatable {
  final String id;
  final String email;
  final String name;
  
  const UserEntity({
    required this.id,
    required this.email,
    required this.name,
  });
  
  @override
  List<Object> get props => [id, email, name];
}

// ‚úÖ CORRECTO: Repository Interface (con prefijo i_)
abstract class IAuthRepository {
  Future<Either<AuthFailure, UserEntity>> login({
    required String email,
    required String password,
  });
}

// ‚úÖ CORRECTO: Use Case
class LoginUseCase {
  final IAuthRepository repository;
  
  LoginUseCase({required this.repository});
  
  Future<Either<AuthFailure, UserEntity>> call({
    required String email,
    required String password,
  }) async {
    return await repository.login(email: email, password: password);
  }
}
```

#### Presentation Layer (`presentation/`)

**Prop√≥sito**: UI, widgets y manejo de estado.

**Reglas**:
- **OBLIGATORIO**: Usar BLoC/Cubit para state management
- **OBLIGATORIO**: Separar BLoC, Events y States en archivos diferentes
- **OBLIGATORIO**: Pages deben ser StatelessWidget cuando sea posible
- **OBLIGATORIO**: Widgets espec√≠ficos de la feature en `widgets/`
- **OBLIGATORIO**: Usar theme system para estilos

```dart
// ‚úÖ CORRECTO: BLoC Structure
// auth_bloc.dart
class AuthBloc extends Bloc<AuthEvent, AuthState> {
  final LoginUseCase loginUseCase;
  
  AuthBloc({required this.loginUseCase}) : super(AuthInitial()) {
    on<LoginRequested>(_onLoginRequested);
  }
  
  Future<void> _onLoginRequested(
    LoginRequested event,
    Emitter<AuthState> emit,
  ) async {
    emit(AuthLoading());
    
    final result = await loginUseCase(
      email: event.email,
      password: event.password,
    );
    
    result.fold(
      (failure) => emit(AuthError(failure)),
      (user) => emit(AuthAuthenticated(user)),
    );
  }
}

// ‚úÖ CORRECTO: Page Structure
class LoginPage extends StatelessWidget {
  const LoginPage({super.key});
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(
          'Login',
          style: Theme.of(context).textTheme.titleLarge,
        ),
      ),
      body: BlocProvider(
        create: (context) => getIt<AuthBloc>(),
        child: const LoginForm(),
      ),
    );
  }
}
```

---

## üö´ Reglas de Prohibici√≥n

### ‚ùå PROHIBIDO

1. **Crear archivos fuera de la estructura definida**
   ```dart
   // ‚ùå INCORRECTO: Archivo en ra√≠z de lib/
   lib/user_service.dart
   
   // ‚úÖ CORRECTO: En la feature correspondiente
   lib/features/auth/data/sources/auth_api_source.dart
   ```

2. **Usar `datasources/` en lugar de `sources/`**
   ```dart
   // ‚ùå INCORRECTO: Nombre antiguo
   lib/features/auth/data/datasources/auth_remote_datasource.dart
   
   // ‚úÖ CORRECTO: Usar sources/
   lib/features/auth/data/sources/auth_api_source.dart
   ```

3. **No usar prefijo `i_` en interfaces de repositorio**
   ```dart
   // ‚ùå INCORRECTO: Sin prefijo
   lib/features/auth/domain/repositories/auth_repository.dart
   
   // ‚úÖ CORRECTO: Con prefijo i_
   lib/features/auth/domain/repositories/i_auth_repository.dart
   ```

4. **Mezclar capas de arquitectura**
   ```dart
   // ‚ùå INCORRECTO: Entity con dependencias de Flutter
   class UserEntity {
     Widget buildWidget() { ... } // ‚ùå NO
   }
   
   // ‚úÖ CORRECTO: Entity pura
   class UserEntity {
     final String id;
     final String name;
   }
   ```

5. **Duplicar c√≥digo que deber√≠a estar en core/**
   ```dart
   // ‚ùå INCORRECTO: Logger en cada feature
   class AuthService {
     void log(String message) {
       print(message); // ‚ùå NO
     }
   }
   
   // ‚úÖ CORRECTO: Usar logger de core
   import 'package:app/core/utils/logger.dart';
   
   class AuthService {
     void doSomething() {
       logger.i('Action performed'); // ‚úÖ S√ç
     }
   }
   ```

6. **Crear widgets gen√©ricos en features/**
   ```dart
   // ‚ùå INCORRECTO: Widget gen√©rico en feature
   lib/features/auth/presentation/widgets/loading_indicator.dart
   
   // ‚úÖ CORRECTO: Widget gen√©rico en common
   lib/common/widgets/loading_indicator.dart
   ```

---

## üìù Convenciones de Nomenclatura

### Archivos
- **Snake_case** para todos los archivos: `user_repository.dart`
- **Sufijos descriptivos**:
  - `_impl.dart` para implementaciones
  - `_model.dart` para DTOs
  - `_entity.dart` para entidades de dominio
  - `_bloc.dart`, `_event.dart`, `_state.dart` para BLoC
  - `_usecase.dart` para casos de uso
- **Prefijos para interfaces**:
  - `i_` para interfaces de repositorio: `i_auth_repository.dart`
- **Nombres de sources**:
  - `[feature]_api_source.dart` para fuentes REST/API
  - `[feature]_local_source.dart` para fuentes locales (cache)
  - `[feature]_firestore_source.dart` para fuentes Firestore

### Carpetas
- **Snake_case** para carpetas: `sources/` (NO `datasources/`), `use_cases/`
- **Singular** para entidades: `entity/`, `model/`
- **Plural** para colecciones: `widgets/`, `pages/`

---

## ‚úÖ Checklist de Implementaci√≥n

Antes de crear un archivo, verificar:

- [ ] ¬øEl archivo est√° en la carpeta correcta seg√∫n su prop√≥sito?
- [ ] ¬øSigue la convenci√≥n de nomenclatura?
- [ ] ¬øEst√° en la capa correcta (data/domain/presentation)?
- [ ] ¬øUsa las interfaces/abstracciones correctas?
- [ ] ¬øNo duplica funcionalidad existente en `core/` o `common/`?
- [ ] ¬øImplementa `Either<Failure, T>` para operaciones que pueden fallar?
- [ ] ¬øUsa el theme system para estilos?
- [ ] ¬øEst√° registrado en `injection.dart` si es necesario?

---

## üîÑ Flujo de Dependencias

**OBLIGATORIO**: Respetar el flujo de dependencias:

```
presentation ‚Üí domain ‚Üê data
     ‚Üì           ‚Üë
   BLoC/Cubit  UseCase
     ‚Üì           ‚Üë
   Pages      Repository (interface)
     ‚Üì           ‚Üë
   Widgets   Repository (impl)
```

**Reglas**:
- **Presentation** puede depender de **Domain**
- **Data** puede depender de **Domain**
- **Domain** NO puede depender de **Presentation** ni **Data**
- **Presentation** NO puede depender directamente de **Data**

---

## üìö Referencias

- **Documentaci√≥n completa**: `docs/flujo_de_arquitectura.md`
- **Clean Architecture**: Seguir principios SOLID
- **BLoC Pattern**: Ver `docs/bloc_good_practices.md`
- **Error Handling**: Ver `docs/error_handling_flow.md`

---

## @todo

- [ ] Validar estructura con an√°lisis est√°tico
- [ ] Crear templates de archivos para nuevas features
- [ ] Documentar patrones de migraci√≥n de c√≥digo existente

---

**√öltima actualizaci√≥n**: Actualizaci√≥n seg√∫n `docs/flujo_de_arquitectura.md` - Cambio de `datasources/` a `sources/`, prefijo `i_` para interfaces de repositorio, y estructura de sources (api, local, firestore)
